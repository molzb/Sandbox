<!DOCTYPE html>
<html>
	<head>
		<title>Kreisel</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<script type="text/javascript" src="js/jquery-1.11.1.js"></script>
		<script type="text/javascript">
			"use strict";
			var dragX = 0, dragY = 0, nowT = 0;
			var dragDeltaX = 0, dragDeltaY = 0, deltaT = 0;
			var deltaX = 0, deltaY = 0;
			var pid = 0, timeId = 0;

			var cntFinishs = 5;
			var cntRemainFinishs = 5;
			var cntStrokes = 0;
			var cntTime = 90.0;
			var score = 0;
			var hiscore = 0;
			
			var hiscores = [{name: "bm", score: 1000},{name: "bm", score: 2000},{name: "bm", score: 3000},
				{name: "bm", score: 4000},{name: "bm", score: 5000}];

			$(document).ready(function() {
				blinkArrows();

				$("canvas").mousedown(function(e) {
					dragX = e.pageX;
					dragY = e.pageY;
					nowT = window.performance.now();
					
					if (timeId === 0) {
						updateTime();
					}
				});
				$("canvas").mouseup(function(e) {
					dragDeltaX = e.pageX - dragX;
					dragDeltaY = e.pageY - dragY;
					deltaT = parseInt(window.performance.now() - nowT);
					deltaX = dragDeltaX / deltaT;
					deltaY = dragDeltaY / deltaT;
					$("#strokes").text(++cntStrokes);
					showDebug(deltaX, deltaY, deltaT);

					rotate(deltaX, deltaY);
				});
			});

			function updateTime() {
				var timeInterval = 100;
				var time = $("#time");
				timeId = window.setInterval(function() {
					cntTime -= 0.1;
					var strTime = Math.round(cntTime * 10) / 10;
					
					if (cntTime < 10.0 && !time.hasClass("timeWarn")) {
						time.addClass("timeWarn");
						playDingDingDing();
					}
					if (cntTime < 0.1) {
						window.clearInterval(pid);
						$("#outoftime").show(500);
						window.clearInterval(timeId);
					}
					
					time.text(strTime + " s");
				}, timeInterval);
			}
			
			function playDingDingDing() {
				var cntDing = 2;
				var ding = $("#ding")[0];
				ding.play();
				var dingdingdingId = window.setInterval(function() {
					console.log("ding");
					ding.play();
					cntDing--;
					if (cntDing === 0)
						window.clearInterval(dingdingdingId);
				}, 800);
			}

			function blinkArrows() {
				var blink = 0;
				var blinkId = window.setInterval(function() {
					var vis = $("#arrow1,#arrow2").css("visibility");
					$("#arrow1,#arrow2").css("visibility", vis === "hidden" ? "visible" : "hidden");
					if (blink++ >= 3) {
						window.clearInterval(blinkId);
						window.setTimeout(function() { $("#explanation").hide(); }, 1000);
					}
				}, 500);
			}

			function showDebug(deltaX, deltaY, deltaT) {
				$("#debug #dx").text(Math.round(deltaX * 100) / 100);
				$("#debug #dy").text(Math.round(deltaY * 100) / 100);
				$("#debug #dt").text(deltaT + " ms");
			}

			function draw() {
				var c = document.getElementById("myCanvas");
				var ctx = c.getContext("2d");

				var colors = [
					['blue', 'yellow'],
					['white', 'pink'],
					['green', 'red'],
					['white', 'black'],
					['green', 'blue'],
					['red', 'green', 'blue']
				];

				for (var i = 0; i < 12; i++) {
					for (var cIdx = 0, p = 0; p < 120; p += 20, cIdx++) {
						var cols = colors[cIdx];
						for (var r = p; r < p + 20; r++) {
							ctx.beginPath();
							ctx.arc(125, 125, r, (i - 1) * Math.PI / 6.0, i * Math.PI / 6.0);
							ctx.strokeStyle = cols[i % cols.length];
							ctx.stroke();
						}
					}
				}
			}

			function rotate(deltaX, deltaY) {
				var animSteps = 100;
				var deg = 0;
				var c = document.getElementById("myCanvas");
				if (pid > 0)
					window.clearInterval(pid);
				var x = parseFloat($(c).css("left")), y = parseFloat($(c).css("top"));
				pid = window.setInterval(function() {
					x += deltaX * 5;
					y += deltaY * 5;
					c.style.left = Math.round(x) + "px", c.style.top = Math.round(y) + "px";
					c.style.transform = 'rotate(' + deg + 'deg)';
					deg = (deltaX > 0) ? deg + 4 : deg -4;

					checkIfLost();
					readDistance();

					if (animSteps-- === 0) {
						window.clearInterval(pid);
					}
				}, 10);
			}
			
			function checkIfLost() {
				var canvas = $("#myCanvas");
				var width = parseInt(canvas.css("width")), height = parseInt(canvas.css("height"));
				var left  = parseInt(canvas.css("left")),  top = parseInt(canvas.css("top"));
				if (left < -(width/2) || top < -(height/2)) {
					if (pid > 0)
						window.clearInterval(pid);
					$("#lost").show();
					window.setTimeout(function() {
						$("#lost").hide();
						resetPosition();
					}, 2000);
				}
			}
			
			function resetPosition() {
				var body = $("body"), finish = $("#finish");
				var width = parseInt(body.css("width")), height = parseInt(body.css("height"));
				var maxX = width - parseInt(finish.css("width"));
				var maxY = height - parseInt(finish.css("height"));
				$("#myCanvas").css("left", maxX / 2 + "px").css("top", maxY / 2 + "px");
			}

			function readDistance() {
				var cx = parseInt( $("#myCanvas").css("left") ), cy = parseInt( $("#myCanvas").css("top") );
				var fx = parseInt( $("#finish").css("left") ), fy = parseInt( $("#finish").css("top") );
				var distX = cx - fx, distY = cy - fy;
				var distXY = parseInt(Math.sqrt(distX * distX + distY * distY));
				$("#debug #dDist").text( Math.round(distXY * 100) / 100 );
				if (distXY < 256) {
					changeBgFinish(distXY);
					if (distXY < 50) {
						if (cntRemainFinishs-- <= 0) {
							$("#done").show();
							window.clearInterval(timeId);
							score += parseInt(cntTime * 100);
							$("#score").text(score);
							if (score > hiscore) {
								hiscore = score;
								$("#hiscore").text(hiscore);
							}
						} else {
							moveFinish();
							score += 1000;
							$("#score").text(score);
						}
					}
				}
			}

			function changeBgFinish(distXY) {
				var bg = $("#finish").css("background-color"); // -> rgb(1,23,123)
				var rgbStr = bg.substring(4, bg.length-1);
				var rgb = rgbStr.split(",");
				var r = distXY, g = 255 - distXY, b = rgb[2];
				$("#finish").css("background-color", "rgb(" + r + "," + g + ", " + b + ")");
			}

			function moveFinish() {
				var body = $("body"), finish = $("#finish");
				var width = parseInt(body.css("width")), height = parseInt(body.css("height"));
				var maxX = width  - parseInt(finish.css("width"));
				var maxY = height - parseInt(finish.css("height"));
				var newX = parseInt(Math.random() * maxX), newY = parseInt(Math.random() * maxY);
				finish.css("left", newX + "px").css("top", newY + "px");
			}
		</script>
		<style type="text/css">
			@font-face { font-family: crayonFont; src: url(images/PastelCrayon.ttf) format('truetype'); }
			html { height: 100%; }
			body { background-image: url(images/karo.png); background-repeat: repeat;
				   font-family: crayonFont; overflow: hidden; height: 100%; }
			#myCanvas { position: absolute; left: 50px; top: 100px; z-index: 2; }
			#finish { position: absolute; left: 500px; top: 500px; width: 250px; height: 250px; border-radius: 250px;
					  background-color: red; font-size: 36px; }
			#finish h1 { text-align: center; vertical-align: middle; padding-top: 50px; color: white; }
			#debug { float: right; height: 100px; width: 100px;
					 background-color: #EEEEEE; color: #999999; }
			#done, #lost, #outoftime { position: absolute; display: none; z-index: 3; font-size: 72px; 
									   margin-top: 15%; margin-left: 25%; }
			.arrow { position: absolute; visibility: hidden; }
			.arrow#arrow1 { top: 0px; left: 50px; }
			.arrow#arrow2 { top: 350px; left: 50px; }
			#performance, #scores { font-size: 36px; color: #999999; text-align: center; }
			#performance > span, #scores > span { display: inline-block; width: 20%; text-align: right; }
			#performance #strokes, #performance #time,
			#scores #score, #scores #hiscore { width: 10%; }
			#performance #time.timeWarn { color: red; }
			.splash { position: absolute; min-width: 300px; width: 30%; min-height: 300px; height: 25%; 
					  margin-left: 35%; margin-top: 10%;
					  border: 2px solid black; border-radius: 120px 10px / 10px 120px;
					  font-size: 24px; background-color: white; }
			.splash.hiscores { display: none; }
			.splash > h1 { text-align: center; }
			.splash .info { text-align: center; display: table; width: 100%; }
			.splash .info { display: table; width: 100%; text-align: center; }
			.click { background-image: url(images/hatching.png); background-repeat: repeat; 
					 font-size: 24px; border: 2px solid black; padding: 10px; }
			.click:active { font-weight: normal; }
			.click:hover { font-weight: bold; }
			#outoftime .click { position: absolute; text-align: center; width: 100%; }
			#copyright { position: absolute; bottom: 20px; right: 20px; color: #999999;
						 transform: rotate(90deg); transform-origin: right; }
		</style>
	</head>
	<body onload="draw()">
		<audio id="ding" src="resources/WindowsDing3.mp3">&nbsp;</audio> 
		<div id="debug">
			&Delta;x: <span id="dx">&nbsp;</span><br/>
			&Delta;y: <span id="dy">&nbsp;</span><br/>
			&Delta;t: <span id="dt">&nbsp;</span><br/>
			&Delta;Dist: <span id="dDist">&nbsp;</span>
		</div>
		<canvas id="myCanvas" width="250" height="250">
			Your browser does not support the HTML5 canvas tag.</canvas>
		<img id="arrow1" class="arrow" src="images/arrowRight.png" alt="Arrow"/>
		<img id="arrow2" class="arrow" src="images/arrowRight.png" alt="Arrow"/>
		<div id="finish">
			<h1>Finish</h1>
		</div>
		
		<div class="splash" onclick="$(this).hide(500)">
			<h1>Toy Top</h1>
			<span class="info">
				Move the toy top to 'Finish'.<br/>
				Goal: reach 5 'Finish'es in 90 seconds.<br/><br/>
				<span class="click">Click to continue</span>
			</span>
		</div>
		
		<div class="splash hiscores" onclick="$(this).hide(500)">
			<h1>Hiscores</h1>
			<span class="info">
				<span class="click">Click to continue</span>
			</span>
		</div>
		
		<div id="copyright">
			&copy;Bernhard Molz
		</div>
		
		<div id="performance">
			<span>Strokes:</span><span id="strokes">0</span>
			<span>Time:</span><span id="time">Go!</span>
		</div>
		<div id="scores">
			<span>Score:</span><span id="score">0</span>
			<span>Hiscore:</span><span id="hiscore">0</span>
		</div>

		<div id="done">You made it!</div>
		<div id="lost">You're lost!<br>You lose 2s.</div>
		<div id="outoftime">
			Out of time!<br/>
			<span class="click">Click to continue</span>
		</div>
	</body>
</html>
